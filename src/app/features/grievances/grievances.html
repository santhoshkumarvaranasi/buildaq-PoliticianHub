<div class="page-container">
  <div class="page-header">
    <div>
      <h1>Public Grievance Desk</h1>
      <p class="subtitle">Track and manage citizen complaints with auto-routing and SLA monitoring</p>
    </div>
    <div class="header-actions">
      <button mat-icon-button [color]="autoRefresh ? 'primary' : ''" (click)="toggleAutoRefresh()" matTooltip="Auto Refresh">
        <mat-icon>{{autoRefresh ? 'sync' : 'sync_disabled'}}</mat-icon>
      </button>
      <button mat-icon-button (click)="refreshData()" matTooltip="Refresh Now">
        <mat-icon>refresh</mat-icon>
      </button>
      <button mat-stroked-button (click)="exportAllToCSV()">
        <mat-icon>download</mat-icon>
        Export CSV
      </button>
      <button mat-raised-button color="primary" (click)="addGrievance()">
        <mat-icon>add</mat-icon>
        Add Grievance
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <mat-card class="stat-card">
      <div class="stat-label">Total Grievances</div>
      <div class="stat-value">{{ stats.total }}</div>
    </mat-card>
    <mat-card class="stat-card status-open">
      <div class="stat-label">Open</div>
      <div class="stat-value">{{ stats.open }}</div>
    </mat-card>
    <mat-card class="stat-card status-progress">
      <div class="stat-label">In Progress</div>
      <div class="stat-value">{{ stats.inProgress }}</div>
    </mat-card>
    <mat-card class="stat-card status-resolved">
      <div class="stat-label">Resolved</div>
      <div class="stat-value">{{ stats.resolved }}</div>
      <div class="stat-meta">{{ stats.todayResolved }} today</div>
    </mat-card>
    <mat-card class="stat-card priority-high">
      <div class="stat-label">High Priority</div>
      <div class="stat-value">{{ stats.highPriority }}</div>
    </mat-card>
    <mat-card class="stat-card sla-breached">
      <div class="stat-label">SLA Breached</div>
      <div class="stat-value">{{ stats.slaBreached }}</div>
    </mat-card>
    <mat-card class="stat-card avg-time">
      <div class="stat-label">Avg Resolution</div>
      <div class="stat-value">{{ stats.avgResolutionTime }}</div>
    </mat-card>
  </div>

  <!-- Bulk Actions Bar -->
  <mat-card class="bulk-actions-bar" *ngIf="selectedGrievances.size > 0">
    <div class="bulk-info">
      <mat-icon>info</mat-icon>
      <span>{{ selectedGrievances.size }} grievance(s) selected</span>
    </div>
    <div class="bulk-actions">
      <button mat-stroked-button (click)="bulkAssign()">
        <mat-icon>person_add</mat-icon>
        Bulk Assign
      </button>
      <button mat-stroked-button (click)="bulkStatusUpdate()">
        <mat-icon>update</mat-icon>
        Update Status
      </button>
      <button mat-stroked-button (click)="bulkExport()">
        <mat-icon>download</mat-icon>
        Export Selected
      </button>
      <button mat-icon-button (click)="selectedGrievances.clear()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filters-card">
    <div class="filters-header">
      <h3>Filters</h3>
      <button mat-button color="primary" (click)="clearFilters()">
        <mat-icon>clear_all</mat-icon>
        Clear All
      </button>
    </div>
    <div class="filters-row">
      <mat-form-field appearance="outline">
        <mat-label>Search</mat-label>
        <input matInput [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Ticket, citizen, category...">
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Status</mat-label>
        <mat-select [(value)]="filterStatus" (selectionChange)="applyFilters()">
          <mat-option value="all">All Status</mat-option>
          <mat-option value="Open">Open</mat-option>
          <mat-option value="In Progress">In Progress</mat-option>
          <mat-option value="Resolved">Resolved</mat-option>
          <mat-option value="Closed">Closed</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Priority</mat-label>
        <mat-select [(value)]="filterPriority" (selectionChange)="applyFilters()">
          <mat-option value="all">All Priority</mat-option>
          <mat-option value="High">High</mat-option>
          <mat-option value="Medium">Medium</mat-option>
          <mat-option value="Low">Low</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Ward</mat-label>
        <mat-select [(value)]="filterWard" (selectionChange)="applyFilters()">
          <mat-option value="all">All Wards</mat-option>
          <mat-option *ngFor="let i of [1,2,3,4,5,8,12,18,22]" [value]="i.toString()">Ward {{ i }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Date Range</mat-label>
        <mat-select [(value)]="filterDateRange" (selectionChange)="applyFilters()">
          <mat-option value="all">All Time</mat-option>
          <mat-option value="today">Today</mat-option>
          <mat-option value="week">This Week</mat-option>
          <mat-option value="month">This Month</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- Grievances Table -->
  <mat-card class="table-card">
    <div class="table-header">
      <h3>Grievances List ({{ filteredGrievances.length }})</h3>
    </div>
    <table mat-table [dataSource]="filteredGrievances" class="grievances-table">
      
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (change)="toggleAllSelection()" [checked]="isAllSelected()"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let grievance">
          <mat-checkbox [checked]="isSelected(grievance.id)" (change)="toggleSelection(grievance.id)"></mat-checkbox>
        </td>
      </ng-container>

      <ng-container matColumnDef="ticketNumber">
        <th mat-header-cell *matHeaderCellDef>Ticket #</th>
        <td mat-cell *matCellDef="let grievance">
          <strong>{{ grievance.ticketNumber }}</strong>
        </td>
      </ng-container>

      <ng-container matColumnDef="citizen">
        <th mat-header-cell *matHeaderCellDef>Citizen</th>
        <td mat-cell *matCellDef="let grievance">{{ grievance.citizen }}</td>
      </ng-container>

      <ng-container matColumnDef="ward">
        <th mat-header-cell *matHeaderCellDef>Ward</th>
        <td mat-cell *matCellDef="let grievance">
          <span class="ward-badge">{{ grievance.ward }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Category</th>
        <td mat-cell *matCellDef="let grievance">
          <div class="category-cell">
            <strong>{{ grievance.category }}</strong>
            <small>{{ grievance.subcategory }}</small>
          </div>
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let grievance">
          <mat-chip [color]="getStatusColor(grievance.status)">{{ grievance.status }}</mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="priority">
        <th mat-header-cell *matHeaderCellDef>Priority</th>
        <td mat-cell *matCellDef="let grievance">
          <mat-chip [color]="getPriorityColor(grievance.priority)">{{ grievance.priority }}</mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="channel">
        <th mat-header-cell *matHeaderCellDef>Channel</th>
        <td mat-cell *matCellDef="let grievance">
          <span class="channel-badge">{{ grievance.channel }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="assignedTo">
        <th mat-header-cell *matHeaderCellDef>Assigned To</th>
        <td mat-cell *matCellDef="let grievance">{{ grievance.assignedTo }}</td>
      </ng-container>

      <ng-container matColumnDef="submittedDate">
        <th mat-header-cell *matHeaderCellDef>Submitted</th>
        <td mat-cell *matCellDef="let grievance">{{ grievance.submittedDate }}</td>
      </ng-container>

      <ng-container matColumnDef="slaStatus">
        <th mat-header-cell *matHeaderCellDef>SLA</th>
        <td mat-cell *matCellDef="let grievance">
          <mat-chip [color]="getSlaColor(grievance.slaStatus)">{{ grievance.slaStatus }}</mat-chip>
        </td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Actions</th>
        <td mat-cell *matCellDef="let grievance">
          <button mat-icon-button [matMenuTriggerFor]="menu">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="viewGrievance(grievance)">
              <mat-icon>visibility</mat-icon>
              <span>View Details</span>
            </button>
            <button mat-menu-item (click)="assignGrievance(grievance)">
              <mat-icon>person_add</mat-icon>
              <span>Assign</span>
            </button>
            <button mat-menu-item (click)="updateStatus(grievance)">
              <mat-icon>update</mat-icon>
              <span>Update Status</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
    </table>
  </mat-card>
</div>
